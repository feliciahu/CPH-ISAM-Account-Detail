--PULL CPH ISAM SALES DETAIL
-- select current_role();
-- select current_secondary_roles();

USE ROLE SBX_EA_GENERAL_FR;
USE SECONDARY ROLES ALL;

CREATE OR REPLACE TEMPORARY TABLE ISAM AS 
SELECT DISTINCT REP_ID
FROM PRD_PSAS_ANALYTICS_DB.GOLD_CRM.VW_REP_HIERARCHY 
WHERE CURRENT_RECORD_IND = 'Y' 
AND BUS_SGMNT = 'CPH'
AND ROLE_TYPE = 'ISAM'
--AND REP_NAME NOT IN ('UNASSIGNED SALES USER','AHMAD GAZI','JON STRAUGHN')
GROUP BY 1;

SELECT *
FROM PRD_PSAS_ANALYTICS_DB.GOLD_CRM.VW_REP_HIERARCHY 
WHERE CURRENT_RECORD_IND = 'Y' 
AND BUS_SGMNT = 'CPH'
AND ROLE_TYPE = 'ISAM';
AND CUST_ACCT_ID='274924'


CREATE OR REPLACE TEMPORARY TABLE CUST_PREP AS 
SELECT *  
FROM PRD_PSAS_ANALYTICS_DB.GOLD_CRM.VW_REP_HIERARCHY 
WHERE REP_ID IN (SELECT * FROM ISAM)
AND CURRENT_RECORD_IND = 'Y'
UNION
SELECT *
FROM PRD_PSAS_ANALYTICS_DB.GOLD_CRM.VW_REP_HIERARCHY
WHERE REP_NAME = 'UNASSIGNED SALES USER'
AND CURRENT_RECORD_IND = 'Y' 
AND BUS_SGMNT = 'CPH'
AND ROLE_TYPE = 'ISAM';

CREATE OR REPLACE TEMPORARY TABLE VPS AS 
SELECT DISTINCT CUST_ACCT_ID,VPS_NUMBER,VPS_NAME
FROM SBX_PSAS_DB.ANALYTICS.T_CPH_ACCT_LEVEL_HIERARCHY WHERE YR_MTH='2024-03-01'
GROUP BY 1,2,3;

CREATE OR REPLACE TEMPORARY TABLE CUST AS 
SELECT A.*,B.VPS_NUMBER AS VPS_ID,B.VPS_NAME AS VPS
FROM CUST A
LEFT JOIN VPS B
ON A.CUST_ACCT_ID=B.CUST_ACCT_ID;

--SELECT * FROM CUST;

CREATE OR REPLACE TEMPORARY TABLE SLS AS 

SELECT  CUST.CUST_ACCT_ID,
        CUST_ACCT_NAM,
        ACTIVE_CUST_IND,
        COMMON_GRP_NAME,
        COMMON_ENTITY_NAME,
        DIM_CUST_ACCT_CURR.SLS_TERR_ID,
        CUST.REP_NAME,
        CUST.REP_ID,
        CUST.USR_MNGR_NAME,
        CUST.VPS_ID,
        CUST.VPS,
        CUST.EFFECTIVE_DT,
        CUST.EXPIRATION_DT,
        CAL_YR_PERIOD AS YR_MONTH,
        
        SUM(SLS_QTY) AS "SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "BX_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "GX_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "SX_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "BIO_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN SLS_QTY ELSE 0 END) AS "OTC_SLS_QTY",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN SLS_QTY ELSE 0 END) AS "MPB_SLS_QTY",
        
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'OneStop' THEN SLS_QTY ELSE 0 END) AS "OS_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'Multisource' OR SLS_CTGRY_FPA_PRG_NAM = 'Network Net' OR SLS_CTGRY_FPA_PRG_NAM = 'NextStop' THEN SLS_QTY ELSE 0 END) AS "MS_NWN_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'Vendor Contract' THEN SLS_QTY ELSE 0 END) AS "VENDOR_CONTRACT_SLS_QTY",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM IS NULL OR SLS_CTGRY_FPA_PRG_NAM = 'Bx' OR SLS_CTGRY_FPA_PRG_NAM = 'Bio' OR SLS_CTGRY_FPA_PRG_NAM = 'Sx' OR SLS_CTGRY_FPA_PRG_NAM = 'Nonsource' THEN SLS_QTY ELSE 0 END) AS "OTHER_SLS_QTY",

        SUM(GROSS_SLS+RTRN) AS "NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "BX_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "GX_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "SX_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "BIO_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "OTC_NET_SLS",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "MPB_NET_SLS",

        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'OneStop' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "OS_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'Multisource' OR SLS_CTGRY_FPA_PRG_NAM = 'Network Net' OR SLS_CTGRY_FPA_PRG_NAM = 'NextStop' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "MS_NWN_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM = 'Vendor Contract' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "VENDOR_CONTRACT_NET_SLS",
        SUM(CASE WHEN SLS_CTGRY_FPA_PRG_NAM IS NULL OR SLS_CTGRY_FPA_PRG_NAM = 'Bx' OR SLS_CTGRY_FPA_PRG_NAM = 'Bio' OR SLS_CTGRY_FPA_PRG_NAM = 'Sx' OR SLS_CTGRY_FPA_PRG_NAM = 'Nonsource' THEN (GROSS_SLS+RTRN) ELSE 0 END) AS "OTHER_NET_SLS",

        SUM(NET_REVENUE) AS "NET_REVENUE",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN NET_REVENUE ELSE 0 END) AS "BX_NET_REVENUE",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN NET_REVENUE ELSE 0 END) AS "GX_NET_REVENUE",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN NET_REVENUE ELSE 0 END) AS "SX_NET_REVENUE",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN NET_REVENUE ELSE 0 END) AS "BIO_NET_REVENUE",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN NET_REVENUE ELSE 0 END) AS "OTC_NET_REVENUE",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN NET_REVENUE ELSE 0 END) AS "MPB_NET_REVENUE",
       
        SUM(GROSS_PROFIT) AS "GROSS_PROFIT",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "BX_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "GX_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "SX_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "BIO_GP",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN GROSS_PROFIT ELSE 0 END) AS "OTC_GP",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN GROSS_PROFIT ELSE 0 END) AS "MPB_GP",        
       
        SUM(VAR_EBIT) AS "EBIT",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP IS NULL OR SLS_CTGRY_PRC_PROD_GRP = 'Bx' AND CMPNY_CD <> '8545' THEN VAR_EBIT ELSE 0 END) AS "BX_EBIT",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Gx' AND CMPNY_CD <> '8545' THEN VAR_EBIT ELSE 0 END) AS "GX_EBIT",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Sx' AND CMPNY_CD <> '8545' THEN VAR_EBIT ELSE 0 END) AS "SX_EBIT",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bio' AND CMPNY_CD <> '8545' THEN VAR_EBIT ELSE 0 END) AS "BIO_EBIT",
        SUM(CASE WHEN SLS_CTGRY_PRC_PROD_GRP = 'Bx OTC' AND CMPNY_CD <> '8545' THEN VAR_EBIT ELSE 0 END) AS "OTC_EBIT",
        SUM(CASE WHEN CMPNY_CD = '8545' THEN VAR_EBIT ELSE 0 END) AS "MPB_EBIT",

        SUM(CUST_RBT) AS "CUST_RBT",
        SUM(RTRN) AS "RTRN"
        
FROM    CUST
JOIN    PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR
ON      LTRIM(CUST.CUST_ACCT_ID,'0') = LTRIM(DIM_CUST_ACCT_CURR.CUST_ACCT_ID,'0')
LEFT JOIN "SBX_PSAS_DB"."SBX_EA_ALL"."V_COPA_EA" COPA
ON      LTRIM(CUST.CUST_ACCT_ID,'0') = LTRIM(COPA.CUST_NUM,'0')
WHERE   CMPNY_CD IN ('8000','8545') -- PSAS & MPB
AND     POST_DT BETWEEN '2023-03-01' AND '2024-02-29'
GROUP BY CUST.CUST_ACCT_ID,
        CUST_ACCT_NAM,
        ACTIVE_CUST_IND,
        COMMON_GRP_NAME,
        COMMON_ENTITY_NAME,
        DIM_CUST_ACCT_CURR.SLS_TERR_ID,
        CUST.REP_NAME,
        CUST.REP_ID,
        CUST.USR_MNGR_NAME,
        CUST.VPS_ID,
        CUST.VPS,
        CUST.EFFECTIVE_DT,
        CUST.EXPIRATION_DT,
        CAL_YR_PERIOD;

--SELECT * FROM SLS;
SELECT TOP 10* FROM PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT

SELECT * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_CUSTOMER_ACCOUNT_INFO 
WHERE ACTIVECUSTOMERINDICATOR='A' AND EFFECTIVE_END>'2024-01-01'
AND ACCOUNTID IN (SELECT DISTINCT CUST_ACCT_ID FROM CUST)